---
title: "Time Series - Covid-19Proj"
author: "Tai Chowdhury and Simerpreet Kaur"
date: "3/27/2021"
output: html_document
---

# Datasets:
1) All Covid
2) Post Vaccine

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tswge)
All_Covid <- read_csv("All_Covid.csv")

Post_Vaccine <- read_csv("Post_Vaccine.csv")

Rolling_Window_ASE = function(series, trainingSize, horizon, s, d, phis, thetas)
{
# trainingSize = 70
# horizon = 12
ASEHolder = numeric()
# s = 10
# d = 0
# phis = phis
# thetas = thetas
for( i in 1:(length(series)-(trainingSize + horizon) + 1))
{
  forecasts = fore.aruma.wge(series[i:(i+(trainingSize-1))],phi = phis, theta = thetas, s = s, d = d,n.ahead = horizon)
  ASE = mean((series[(trainingSize+i):(trainingSize+ i + (horizon) - 1)] - forecasts$f)^2)
  ASEHolder[i] = ASE
}
ASEHolder
hist(ASEHolder)
WindowedASE = mean(ASEHolder)
print(horizon)
print(trainingSize)
print("The Summary Statistics for the Rolling Window ASE Are:")
print(summary(ASEHolder))
print(paste("The Rolling Window ASE is: ",WindowedASE))
return(WindowedASE)
}
```



#############
#### EDA ####
#############

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


# All Covid Data
plotts.wge(All_Covid$new_cases_per_million)
plotts.wge(All_Covid$icu_patients_per_million)
plotts.wge(All_Covid$hosp_patients_per_million)
plotts.wge(All_Covid$new_vaccinations_smoothed_per_million)
plotts.wge(All_Covid$new_deaths_per_million)

# Post Vaccine
plotts.wge(Post_Vaccine$new_cases_per_million)
plotts.wge(Post_Vaccine$icu_patients_per_million)
plotts.wge(Post_Vaccine$hosp_patients_per_million)
plotts.wge(Post_Vaccine$new_vaccinations_smoothed_per_million)
plotts.sample.wge(Post_Vaccine$new_deaths_per_million)

```


#### ARIMA Model 1 (with seasonal 1-b^7 term)


```{r pressure, echo=FALSE}

#Check for white noise
plotts.sample.wge(Post_Vaccine$new_deaths_per_million) #Damped sinusoudal behavior in ACF, also indication of seasonality

# Estimate a model by overfittting:
diff_s7 <- artrans.wge(Post_Vaccine$new_deaths_per_million, 7)
est_m1_1 = est.ar.wge(Post_Vaccine$new_deaths_per_million, p = 10, type = 'burg')

#search for p,q as per lower AIC score
aic5.wge(Post_Vaccine$new_deaths_per_million) # CONCERN: picks 5,1 vs 4,1

#Estimation for final model:

m1_arma = est.arma.wge(diff_s7, p = 5, q = 1)
mean(Post_Vaccine$new_deaths_per_million) #7.093083

fore_m1_short = fore.arma.wge(Post_Vaccine$new_deaths_per_million, phi = m1_arma$phi, theta = m1_arma$theta)
For_ase_m1_short = mean((fore_m1_short$f - Post_Vaccine$new_deaths_per_million[(95-10+1):95])^2)
For_ase_m1_short #1.77

Rolling_Window_ASE(Post_Vaccine$new_deaths_per_million, trainingSize = 70, horizon = 5, d = 1, phi = m1_arma$phi, theta = m1_arma$theta,s= 7)#5.392431


## Colored Plot for short term
plot(seq(1,96,1), Post_Vaccine$new_deaths_per_million, type = "l",xlim = c(0,100), ylab = "Deaths Per Million", main = "6 day death rate forecast ")
lines(seq(96,100,1), fore_m1_short$f, type = "l", col = "red")
seq
## Colored Plot for long term
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,136))
lines(seq((136-40+1),136,1),m3_forcast_long_40$f, col = "red")

```

#### ARMA MODEL 2 - (with differencing = 1, (5,2))  ####


```{r pressure, echo=FALSE}

m2_dif1 = artrans.wge(Post_Vaccine$new_deaths_per_million,1)

# Estimate a model by overfittting:

est_m1_2 = est.ar.wge(Post_Vaccine$new_deaths_per_million, p = 8, type = 'burg') # It contains (1-B) as 

#search for p,q as per lower AIC score
aic5.wge(m2_dif1) #picks 5,2

#Estimation for final model:

m2_arma = est.arma.wge(m2_dif1, p = 5, q = 2)
mean(Post_Vaccine$new_deaths_per_million) #7.093083

fore_m2_short = fore.arma.wge(Post_Vaccine$new_deaths_per_million, phi = m2_arma$phi, theta = m2_arma$theta)
For_ase_m2_short = mean((fore_m2_short$f - Post_Vaccine$new_deaths_per_million[(95-10+1):95])^2)
For_ase_m2_short #1.77

## Colored Plot for short term
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,96))
lines(seq(87,96,1),m4_forcast_short$f  , col = "red")



```


#### ARIMA - (with (4,1) seanality )  ####


```{r pressure, echo=FALSE}

m2_dif1 = artrans.wge(Post_Vaccine$new_deaths_per_million,1)

# Estimate a model by overfittting:

est_m1_2 = est.ar.wge(Post_Vaccine$new_deaths_per_million, p = 8, type = 'burg') # It contains (1-B) as 

#search for p,q as per lower AIC score
aic5.wge(m2_dif1) #picks 5,2

#Estimation for final model:

m2_arma = est.arma.wge(m2_dif1, p = 5, q = 2)
mean(Post_Vaccine$new_deaths_per_million) #7.093083

fore_m2_short = fore.arma.wge(Post_Vaccine$new_deaths_per_million, phi = m2_arma$phi, theta = m2_arma$theta)
For_ase_m2_short = mean((fore_m2_short$f - Post_Vaccine$new_deaths_per_million[(95-10+1):95])^2)
For_ase_m2_short #1.77

## Colored Plot for short term
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,96))
lines(seq(87,96,1),m4_forcast_short$f  , col = "red")



```

#### Multivariate  (No Trend/lag) ####



```{r pressure, echo=FALSE}
# Explanatory Variable
expvar_vaccine = data.frame(Post_Vaccine$new_cases_per_million, Post_Vaccine$icu_patients_per_million,
                         Post_Vaccine$hosp_patients_per_million,Post_Vaccine$new_vaccinations_smoothed_per_million)

# All data with no lag and no trend
covfit1=lm(new_deaths_per_million~ new_cases_per_million+icu_patients_per_million+hosp_patients_per_million
          +new_vaccinations_smoothed_per_million, data = Post_Vaccine)
AIC(covfit1)#425.1261
summary(covfit1) # new_vaccinations_smoothed_per_million  2.213e-05  2.587e-04   0.086    0.932 

deathrate_res= is.numeric(aic.wge(covfit1$residuals,p=0:10, q=0))  # AIC picks p=9

acf(covfit1$residuals)

fit1=arima(Post_Vaccine$new_deaths_per_million,order=c(9,0,0),xreg=expvar_vaccine)
fit1
AIC(fit1) #322.8156

acf(fit1$residuals) # looks like white noise behavior
ltest = ljung.wge(fit$resid)
ltest$pval


# ASE for model with no lag and no trend (last 5)
Post_Vaccine2 = Post_Vaccine[1:91,]

expvar_vaccine2 = data.frame(Post_Vaccine2$new_cases_per_million, Post_Vaccine2$icu_patients_per_million,
                         Post_Vaccine2$hosp_patients_per_million,Post_Vaccine2$new_vaccinations_smoothed_per_million)

covidfit2_mi=lm(new_deaths_per_million~ new_cases_per_million+icu_patients_per_million+hosp_patients_per_million
          +new_vaccinations_smoothed_per_million, data = Post_Vaccine2)
AIC(covidfit2_mi) #402.4385

M1_final_res=aic.wge(covidfit2_mi$residuals,p=0:10, q=0)  # AIC picks p=9
fit2_m1=arima(Post_Vaccine2$new_deaths_per_million,order=c(9,0,0),xreg=cbind(Post_Vaccine2$new_cases_per_million, Post_Vaccine2$icu_patients_per_million,Post_Vaccine2$hosp_patients_per_million, Post_Vaccine2$new_vaccinations_smoothed_per_million))
fit2_m1
AIC(fit2_m1) #312.5972

#Pred for short term  
preds1 = predict(fit2_m1, newxreg = cbind(Post_Vaccine$new_cases_per_million[91:96], Post_Vaccine$icu_patients_per_million[91:96],Post_Vaccine$hosp_patients_per_million[91:96], Post_Vaccine$new_vaccinations_smoothed_per_million[91:96]))
preds1$pred
ASE1 = mean((Post_Vaccine$new_deaths_per_million[91:96] - preds1$pred)^2)
ASE1 #2.076967

# Pred for long term
preds_1 = predict(fit2_m1, newxreg = cbind(Post_Vaccine$new_cases_per_million[57:96], Post_Vaccine$icu_patients_per_million[57:96],Post_Vaccine$hosp_patients_per_million[57:96], Post_Vaccine$new_vaccinations_smoothed_per_million[57:96]))
preds1$pred
ASE_1 = mean((Post_Vaccine$new_deaths_per_million[57:96] - preds_1$pred)^2)
ASE_1

#Rolling Window 
Rolling_Window_ASE(Post_Vaccine$new_deaths_per_million, trainingSize = 70, horizon = 6, d = 0, phi = fit2_m1$phi, theta = 0,s= 0)

## Colored forecast plot for last 6 days
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,96))
lines(seq(91,96,1),preds1$pred, col = "red")

## Colored forecast plot for short term
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,105))
lines(seq(97,102,1),preds1$pred, col = "red")

## Colored forecast plot for long term #NEED WORK
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,150))
lines(seq(97,136,1),preds_1$pred, col = "red")

```


#### Multivariate  ( Trend added, no lag ) ####



```{r pressure, echo=FALSE}
#with trend

# ASE for model with no lag and trend (last 5)
t=1:96
Post_Vaccine$t = t
Post_Vaccine2 = Post_Vaccine[1:91,]
covidfit2_m2=lm(new_deaths_per_million~ t+ new_cases_per_million+icu_patients_per_million+hosp_patients_per_million
          +new_vaccinations_smoothed_per_million, data = Post_Vaccine2)
AIC(covidfit2_m2) #401.0608

M2_final_res=aic.wge(covidfit2_m2$residuals,p=0:10, q=0)  # AIC picks p=9
fit2_m2=arima(Post_Vaccine2$new_deaths_per_million,order=c(9,0,0),xreg=cbind(Post_Vaccine2$new_cases_per_million, Post_Vaccine2$icu_patients_per_million,Post_Vaccine2$hosp_patients_per_million, Post_Vaccine2$new_vaccinations_smoothed_per_million))
fit2_m2
AIC(fit2_m2) #312.5972

#Rolling Window 
Rolling_Window_ASE(Post_Vaccine$new_deaths_per_million, trainingSize = 70, horizon = 6, d = 0, phi = fit2_m2$phi, theta = 0,s= 0) #18.18726

# Predictions with trend
preds2 = predict(fit2_m2, newxreg = cbind(Post_Vaccine$new_cases_per_million[91:96], Post_Vaccine$icu_patients_per_million[91:96],Post_Vaccine$hosp_patients_per_million[91:96], Post_Vaccine$new_vaccinations_smoothed_per_million[91:96]))
ASE2 = mean((Post_Vaccine$new_deaths_per_million[91:96] - preds2$pred)^2)
ASE2 #2.491884

# Predictions with trend - long term
preds_2 = predict(fit2_m2, newxreg = cbind(Post_Vaccine$new_cases_per_million[57:96], Post_Vaccine$icu_patients_per_million[57:96],Post_Vaccine$hosp_patients_per_million[57:96], Post_Vaccine$new_vaccinations_smoothed_per_million[57:96]))
preds1$pred
ASE_2 = mean((Post_Vaccine$new_deaths_per_million[57:96] - preds_2$pred)^2)
ASE_2 #7.317226



## Colored forecast plot for last 6 days
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,96))
lines(seq(91,96,1),preds2$pred, col = "red")

## Colored forecast plot for short term
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,105))
lines(seq(97,102,1),preds2$pred, col = "red")

## Colored forecast plot for long term #NEED WORK
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,150))
lines(seq(97,136,1),preds_2$pred, col = "red")


```


#### Multivariate  ( Adding Lags ) ####



```{r pressure, echo=FALSE}

#Lagging Post Vaccine variables
ccf(Post_Vaccine$new_deaths_per_million,Post_Vaccine$new_cases_per_million)
ccf(Post_Vaccine$new_deaths_per_million,Post_Vaccine$icu_patients_per_million)
ccf(Post_Vaccine$new_deaths_per_million,Post_Vaccine$hosp_patients_per_million)
ccf(Post_Vaccine$new_deaths_per_million,Post_Vaccine$new_vaccinations_smoothed_per_million)

new_cases_per_million1 = dplyr::lag(Post_Vaccine$new_cases_per_million,1)
icu_patients_per_million1 = dplyr::lag(Post_Vaccine$icu_patients_per_million,1)
hosp_patients_per_million1 = dplyr::lag(Post_Vaccine$hosp_patients_per_million,1)
new_vaccinations_smoothed_per_million1 = dplyr::lag(Post_Vaccine$new_vaccinations_smoothed_per_million,1)

Post_Vaccine$new_cases_per_million1 = new_cases_per_million1
Post_Vaccine$icu_patients_per_million1 = icu_patients_per_million1
Post_Vaccine$hosp_patients_per_million1 = hosp_patients_per_million1
Post_Vaccine$new_vaccinations_smoothed_per_million1 = new_vaccinations_smoothed_per_million1

# ASE for model3
t=1:96
Post_Vaccine$t = t
Post_Vaccine2 = Post_Vaccine[1:91,]
covidfit3_m3=lm(new_deaths_per_million~ t+ new_cases_per_million1+icu_patients_per_million1+hosp_patients_per_million1
          +new_vaccinations_smoothed_per_million1, data = Post_Vaccine2)
AIC(covidfit3_m3) #422.3541

M3_final_res=aic.wge(covidfit3_m3$residuals,p=0:10, q=0)  # AIC picks p=9
fit3_m3=arima(Post_Vaccine2$new_deaths_per_million,order=c(9,0,0),xreg=cbind(Post_Vaccine2$new_cases_per_million1, Post_Vaccine2$icu_patients_per_million1,Post_Vaccine2$hosp_patients_per_million1, Post_Vaccine2$new_vaccinations_smoothed_per_million1))
fit3_m3
AIC(fit3_m3) #321.61

#Rolling Window 
Rolling_Window_ASE(Post_Vaccine$new_deaths_per_million, trainingSize = 70, horizon = 6, d = 0, phi = fit3_m3$phi, theta = 0,s= 0) #18.18726

# Predictions with trend
preds3 = predict(fit3_m3, newxreg = cbind(Post_Vaccine$new_cases_per_million[91:96], Post_Vaccine$icu_patients_per_million[91:96],Post_Vaccine$hosp_patients_per_million[91:96], Post_Vaccine$new_vaccinations_smoothed_per_million[91:96]))
ASE3 = mean((Post_Vaccine$new_deaths_per_million[91:96] - preds2$pred)^2)
ASE3 #3.045036

# Predictions with trend - long term
preds_3 = predict(fit3_m3, newxreg = cbind(Post_Vaccine$new_cases_per_million[57:96], Post_Vaccine$icu_patients_per_million[57:96],Post_Vaccine$hosp_patients_per_million[57:96], Post_Vaccine$new_vaccinations_smoothed_per_million[57:96]))
preds1$pred
ASE_3 = mean((Post_Vaccine$new_deaths_per_million[57:96] - preds_2$pred)^2)
ASE_3 #6.512361



## Colored forecast plot for last 6 days
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,96))
lines(seq(91,96,1),preds3$pred, col = "red")

## Colored forecast plot for short term
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,105))
lines(seq(97,102,1),preds3$pred, col = "red")

## Colored forecast plot for long term #NEED WORK
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,150))
lines(seq(97,136,1),preds_3$pred, col = "red")



```



#### Forecast Features ####



```{r pressure, echo=FALSE}


ests_newc = aic.wge(Post_Vaccine$new_cases_per_million)
est_new_case = est.arma.wge(Post_Vaccine$new_cases_per_million,p = 5, q = 1)
Fore_newcase = fore.arma.wge(Post_Vaccine$new_cases_per_million,phi = est_new_case$phi, theta = est_new_case$theta, n.ahead = 5)


ests_icu = aic.wge(Post_Vaccine$icu_patients_per_million) #picks 2,1
est_icu = est.arma.wge(Post_Vaccine$icu_patients_per_million,p = 2, q = 1)
Fore_icu = fore.arma.wge(Post_Vaccine$icu_patients_per_million,phi = est_icu$phi, theta = est_icu$theta, n.ahead = 5)

ests_hosp = aic.wge(Post_Vaccine$hosp_patients_per_million) #picks 4,1
est_hosp = est.arma.wge(Post_Vaccine$hosp_patients_per_million,p = 4, q = 1)
Fore_hos = fore.arma.wge(Post_Vaccine$hosp_patients_per_million,phi = est_hosp$phi, theta = est_hosp$theta, n.ahead = 5)

ests_vaccine = aic.wge(Post_Vaccine$new_vaccinations_smoothed_per_million) #picks 3,1
est_vaccine = est.arma.wge(Post_Vaccine$new_vaccinations_smoothed_per_million,p = 3, q = 1)
Fore_vaccine = fore.arma.wge(Post_Vaccine$new_vaccinations_smoothed_per_million,phi = est_vaccine$phi, theta = est_vaccine$theta, n.ahead = 5)

aic5.wge(BSales$ad_online, p = 0:10)
est_online = est.arma.wge(BSales$ad_online,p = 6)
dev.off()
plot.ts(BSales$ad_online[1:100])
ad_onlineFORECAST = fore.arma.wge(BSales$ad_online,phi = est_online$phi, n.ahead = 6)



```

#### with trend and lagging ####



```{r pressure, echo=FALSE}

Fore_newcase1 = lag(Fore_newcase,1)
Fore_icu1 = lag(Fore_icu,1)
Fore_hos1 = lag(Fore_hos,1)
Fore_vaccine1 = lag(Fore_vaccine,1)

t=1:96
Post_Vaccine$t = t
Post_Vaccine2 = Post_Vaccine[1:91,]
covidfit4_m4=lm(new_deaths_per_million~ t+ new_cases_per_million1+icu_patients_per_million1+hosp_patients_per_million1
          +new_vaccinations_smoothed_per_million1, data = Post_Vaccine2)
AIC(covidfit4_m4) #422.4621

M4_final_res=aic.wge(covidfit4_m4$residuals,p=0:10, q=0)  # AIC picks p=9
fit4_m4=arima(Post_Vaccine2$new_deaths_per_million,order=c(8,0,0),xreg=cbind(Post_Vaccine2$new_cases_per_million1, Post_Vaccine2$icu_patients_per_million1,Post_Vaccine2$hosp_patients_per_million1, Post_Vaccine2$new_vaccinations_smoothed_per_million1))
fit4_m4
AIC(fit4_m4)

#Rolling Window NOT WORKING
Rolling_Window_ASE(Post_Vaccine$new_deaths_per_million, trainingSize = 70, horizon = 6, d = 0, phi = fit4_m4$, theta = fit4_m4$,s= 0) #18.18726

# Predictions with trend
preds4 = predict(fit4_m4, newxreg = cbind(Post_Vaccine$new_cases_per_million[91:96], Post_Vaccine$icu_patients_per_million[91:96],Post_Vaccine$hosp_patients_per_million[91:96], Post_Vaccine$new_vaccinations_smoothed_per_million[91:96]))
ASE4 = mean((Post_Vaccine$new_deaths_per_million[91:96] - preds4$pred )^2)
ASE4 #2.528183

# Predictions with trend - long term
preds_4 = predict(fit4_m4, newxreg = cbind(Post_Vaccine$new_cases_per_million[57:96], Post_Vaccine$icu_patients_per_million[57:96],Post_Vaccine$hosp_patients_per_million[57:96], Post_Vaccine$new_vaccinations_smoothed_per_million[57:96]))

ASE_4 = mean((Post_Vaccine$new_deaths_per_million[57:96] - preds_4$pred)^2)
ASE_4 #6.11206



## Colored forecast plot for last 6 days
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,96))
lines(seq(91,96,1),preds4$pred, col = "red")

## Colored forecast plot for short term
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,105))
lines(seq(97,102,1),preds4$pred, col = "red")

## Colored forecast plot for long term #NEED WORK
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,150))
lines(seq(97,136,1),preds_4$pred, col = "red")



```


#### VAR MODEL 1 ####



```{r pressure, echo=FALSE}

VaccineVar1 = VAR(cbind(Post_Vaccine2$new_cases_per_million, Post_Vaccine2$new_deaths_per_million, Post_Vaccine2$icu_patients_per_million,Post_Vaccine2$hosp_patients_per_million, Post_Vaccine2$new_vaccinations_smoothed_per_million), type = 'both', lag.max = 5)
AIC(VaccineVar1) #3084.604

preds6 = predict(VaccineVar1, n.ahead = 6)
preds_6 = predict(VaccineVar1, n.ahead = 40)
ASE5 = mean((Post_Vaccine$new_deaths_per_million[91:96] - preds6$fcst$y2[,1])^2)
ASE5 #11.84746

#Rolling Window NOT WORKING
Rolling_Window_ASE(Post_Vaccine$new_deaths_per_million, trainingSize = 70, horizon = 6, d = 0, phi = VaccineVar1$, theta = fit4_m4$,s= 0) #18.18726

## Colored forecast plot for last 6 days
plot(seq(1,96,1), Post_Vaccine$new_deaths_per_million, type = "l",xlim = c(0,96), ylab = "Death Rate Per Million", main = "forecast plot for last 6 days")
lines(seq(91,96), preds6$fcst$y2[,1], type = "l", col = "red")

## Colored forecast plot for short term
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,105))
lines(seq(97,102,1),preds6$fcst$y2[,1], col = "red")

## Colored forecast plot for long term #NEED WORK
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,150))
lines(seq(97,136,1),preds_6$fcst$y2[,1], col = "red")

```


#### VAR MODEL 2 - const####


```{r pressure, echo=FALSE}

VaccineVar2 = VAR(cbind(Post_Vaccine2$new_cases_per_million, Post_Vaccine2$new_deaths_per_million, Post_Vaccine2$icu_patients_per_million,Post_Vaccine2$hosp_patients_per_million, Post_Vaccine2$new_vaccinations_smoothed_per_million), type = 'const', lag.max = 5)
AIC(VaccineVar2) #3106.866

preds7 = predict(VaccineVar2, n.ahead = 6)
preds_7 = predict(VaccineVar2, n.ahead = 40)

ASE7 = mean((Post_Vaccine$new_deaths_per_million[91:96] - preds7$fcst$y2[,1])^2)
ASE7 #2.584133

#Rolling Window NOT WORKING
Rolling_Window_ASE(Post_Vaccine$new_deaths_per_million, trainingSize = 70, horizon = 6, d = 0, phi = VaccineVar1$, theta = fit4_m4$,s= 0) #18.18726

## Colored forecast plot for last 6 days
plot(seq(1,96,1), Post_Vaccine$new_deaths_per_million, type = "l",xlim = c(0,96), ylab = "Death Rate Per Million", main = "forecast plot for last 6 days")
lines(seq(91,96), preds7$fcst$y2[,1], type = "l", col = "red")

## Colored forecast plot for short term
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,105))
lines(seq(97,102,1),preds7$fcst$y2[,1], col = "red")

## Colored forecast plot for long term #NEED WORK
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,150))
lines(seq(97,136,1),preds_7$fcst$y2[,1], col = "red")
```


#### MLP With Vaccine Variable Only####


```{r pressure, echo=FALSE}
library(nnfor)
library(forecast)
library(vars)
library(tswge)
Vacc_Train = Post_Vaccine[1:90,]
Vacc_Test = Post_Vaccine[91:96,]
Vacc_Train2 = Post_Vaccine[1:56,]
Vacc_Test2 = Post_Vaccine[57:96,]
Vacc_xreg = data.frame(Vaccine = ts(Vacc_Train$new_vaccinations_smoothed_per_million))
set.seed(2)
Vacc_fit.mlp1 = mlp(ts(Vacc_Train$new_deaths_per_million) ,reps = 50,comb = "mean", xreg = Vacc_xreg ) 
Vacc_fit.mlp1_ = mlp(ts(Vacc_Train2$new_deaths_per_million) ,reps = 50,comb = "mean", xreg = Vacc_xreg ) #combine all 50 #combine all 50 forcast
Vacc_fit.mlp1 # 5 hnode #mse 1.11
plot(Vacc_fit.mlp1)
fore_vacc_df_exp = data.frame(Vaccine = ts(Post_Vaccine$new_vaccinations_smoothed_per_million))
Vacc_fore.mlp1 = forecast(Vacc_fit.mlp1, h = 6, xreg = fore_vacc_df) 
Vacc_fore.mlp2 = forecast(Vacc_fit.mlp1_, h = 40, xreg = fore_vacc_df) 
plot(Vacc_fore.mlp1)
MLP_ASE1 = mean((Vacc_Test$new_deaths_per_million- Vacc_fore.mlp1$mean)^2)
MLP_ASE1 #2.030371
  
#Rolling Window NOT WORKING
Rolling_Window_ASE(Post_Vaccine$new_deaths_per_million, trainingSize = 70, horizon = 6, d = 0, phi = Vacc_fit.mlp1$, theta = Vacc_fit.mlp1,s= 0) #18.18726

## Colored forecast plot for last 6 days
plot(seq(1,96,1), Post_Vaccine$new_deaths_per_million, type = "l",xlim = c(0,96), ylab = "Death Rate Per Million", main = "forecast plot for last 6 days")
lines(seq(91,96), Vacc_fore.mlp1$mean, type = "l", col = "red")

## Colored forecast plot for short term
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,105))
lines(seq(97,102,1),Vacc_fore.mlp1$mean, col = "red")

## Colored forecast plot for long term 
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,150))
lines(seq(97,136,1),Vacc_fore.mlp2$mean, col = "red")
```


#### MLP With all explanatory variables####

```{r pressure, echo=FALSE}
library(nnfor)
library(forecast)
library(vars)
library(tswge)
Vacc_Train = Post_Vaccine[1:90,]
Vacc_Test = Post_Vaccine[91:96,]
Vacc_Train22 = Post_Vaccine[1:56,]
Vacc_Test23 = Post_Vaccine[57:96,]
all_exp_xreg = data.frame(Vaccine = ts(Vacc_Train$new_vaccinations_smoothed_per_million), NewCase = ts(Vacc_Train$new_cases_per_million), Hosp = ts(Vacc_Train$hosp_patients_per_million), ICU = ts(Vacc_Train$icu_patients_per_million))
set.seed(2)
exp_fit.mlp1 = mlp(ts(Vacc_Train$new_deaths_per_million) ,reps = 50,comb = "mean", xreg = all_exp_xreg ) #combine all 50 forcast
exp_fit.mlp11 = mlp(ts(Vacc_Train22$new_deaths_per_million) ,reps = 50,comb = "mean", xreg = all_exp_xreg )
exp_fit.mlp11 # 5 hnode #mse 1.11
plot(exp_fit.mlp1)
fore_all_exp_df = data.frame(Vaccine = ts(Post_Vaccine$new_vaccinations_smoothed_per_million), NewCase = ts(Post_Vaccine$new_cases_per_million), Hosp = ts(Post_Vaccine$hosp_patients_per_million), ICU = ts(Post_Vaccine$icu_patients_per_million))
allexp_fore.m2p1 = forecast(exp_fit.mlp1, h = 6, xreg = fore_all_exp_df) 
allexp_fore.m2p2 = forecast(exp_fit.mlp11, h = 40, xreg = fore_all_exp_df) 
plot(allexp_fore.m2p1)
MLP_ASE2 = mean((Vacc_Test$new_deaths_per_million- allexp_fore.m2p1$mean)^2)
MLP_ASE2 #1.988805
MLP_ASE22 = mean((Vacc_Test$new_deaths_per_million- allexp_fore.m2p2$mean)^2)
MLP_ASE22 #4.74864
  
plot(seq(1,96,1), Post_Vaccine$new_deaths_per_million, type = "l",xlim = c(0,96), ylab = "Death Rate Per Million", main = "forecast plot for last 6 days")
lines(seq(91,96), allexp_fore.m2p1$mean, type = "l", col = "red")

## Colored forecast plot for short term
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,105))
lines(seq(97,102,1),allexp_fore.m2p1$mean, col = "red")

## Colored forecast plot for long term 
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,150))
lines(seq(97,136,1),allexp_fore.m2p2$mean, col = "red")
```



#### Ensemble Model with NN (all variables) Model and VAR 2####

```{r pressure, echo=FALSE}

ensemble  = (preds6$fcst$y2[,1] + allexp_fore.m2p1$mean)/2

#Plot
plot(seq(1,96,1), Post_Vaccine$new_deaths_per_million, type = "l",xlim = c(0,96), ylab = "Death Rate Per Million", main = "Ensemble Model with NN (All Var) vs VAR 2 model")
lines(seq(91,96,1), ensemble, type = "l", col = "green")

ASE_en = mean((Post_Vaccine$new_deaths_per_million[91:96] - ensemble)^2)
ASE_en #5.659218



```































