---
title: "Time Series - Covid-19Proj"
author: "Tai Chowdhury and Simerpreet Kaur"
date: "3/27/2021"
output: html_document
---

# Datasets:
1) All Covid
2) Post Vaccine

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tswge)
All_Covid <- read_csv("All_Covid.csv")
Post_Vaccine <- read_csv("Post_Vaccine.csv")

Rolling_Window_ASE = function(series, trainingSize, horizon, s, d, phis, thetas)
{
# trainingSize = 70
# horizon = 12
ASEHolder = numeric()
# s = 10
# d = 0
# phis = phis
# thetas = thetas
for( i in 1:(length(series)-(trainingSize + horizon) + 1))
{
  forecasts = fore.aruma.wge(series[i:(i+(trainingSize-1))],phi = phis, theta = thetas, s = s, d = d,n.ahead = horizon)
  ASE = mean((series[(trainingSize+i):(trainingSize+ i + (horizon) - 1)] - forecasts$f)^2)
  ASEHolder[i] = ASE
}
ASEHolder
hist(ASEHolder)
WindowedASE = mean(ASEHolder)
print(horizon)
print(trainingSize)
print("The Summary Statistics for the Rolling Window ASE Are:")
print(summary(ASEHolder))
print(paste("The Rolling Window ASE is: ",WindowedASE))
return(WindowedASE)
}
```



#############
#### EDA ####
#############

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


# All Covid Data
plotts.wge(All_Covid$new_cases_per_million)
plotts.wge(All_Covid$icu_patients_per_million)
plotts.wge(All_Covid$hosp_patients_per_million)
plotts.wge(All_Covid$new_vaccinations_smoothed_per_million)
plotts.wge(All_Covid$new_deaths_per_million)

# Post Vaccine
plotts.wge(Post_Vaccine$new_cases_per_million)
plotts.wge(Post_Vaccine$icu_patients_per_million)
plotts.wge(Post_Vaccine$hosp_patients_per_million)
plotts.wge(Post_Vaccine$new_vaccinations_smoothed_per_million)
plotts.sample.wge(Post_Vaccine$new_deaths_per_million)

```


#### ARIMA Model 1 (with seasonal 1-b^7 term)


```{r pressure, echo=FALSE}

#Check for white noise
plotts.sample.wge(Post_Vaccine$new_deaths_per_million) #Damped sinusoudal behavior in ACF, also indication of seasonality

# Estimate a model by overfittting:
diff_s7 <- artrans.wge(Post_Vaccine$new_deaths_per_million, 7)
est_m1_1 = est.ar.wge(Post_Vaccine$new_deaths_per_million, p = 10, type = 'burg')

#search for p,q as per lower AIC score
aic5.wge(Post_Vaccine$new_deaths_per_million) # CONCERN: picks 5,1 vs 4,1

#Estimation for final model:

m1_arma = est.arma.wge(diff_s7, p = 5, q = 1)
mean(Post_Vaccine$new_deaths_per_million) #7.093083

fore_m1_short = fore.arma.wge(Post_Vaccine$new_deaths_per_million, phi = m1_arma$phi, theta = m1_arma$theta)
For_ase_m1_short = mean((fore_m1_short$f - Post_Vaccine$new_deaths_per_million[(95-10+1):95])^2)
For_ase_m1_short #1.77

Rolling_Window_ASE(Post_Vaccine$new_deaths_per_million, trainingSize = 70, horizon = 5, d = 1, phi = m1_arma$phi, theta = m1_arma$theta,s= 7)#5.392431


## Colored Plot for short term
plot(seq(1,96,1), Post_Vaccine$new_deaths_per_million, type = "l",xlim = c(0,100), ylab = "Deaths Per Million", main = "6 day death rate forecast ")
lines(seq(96,100,1), fore_m1_short$f, type = "l", col = "red")
seq
## Colored Plot for long term
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,136))
lines(seq((136-40+1),136,1),m3_forcast_long_40$f, col = "red")

```

#### ARMA MODEL 2 - (with differencing = 1, (5,2))  ####


```{r pressure, echo=FALSE}

m2_dif1 = artrans.wge(Post_Vaccine$new_deaths_per_million,1)

# Estimate a model by overfittting:

est_m1_2 = est.ar.wge(Post_Vaccine$new_deaths_per_million, p = 8, type = 'burg') # It contains (1-B) as 

#search for p,q as per lower AIC score
aic5.wge(m2_dif1) #picks 5,2

#Estimation for final model:

m2_arma = est.arma.wge(m2_dif1, p = 5, q = 2)
mean(Post_Vaccine$new_deaths_per_million) #7.093083

fore_m2_short = fore.arma.wge(Post_Vaccine$new_deaths_per_million, phi = m2_arma$phi, theta = m2_arma$theta)
For_ase_m2_short = mean((fore_m2_short$f - Post_Vaccine$new_deaths_per_million[(95-10+1):95])^2)
For_ase_m2_short #1.77

## Colored Plot for short term
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,96))
lines(seq(87,96,1),m4_forcast_short$f  , col = "red")



```


#### ARIMA - (with (4,1) seanality )  ####


```{r pressure, echo=FALSE}

m2_dif1 = artrans.wge(Post_Vaccine$new_deaths_per_million,1)

# Estimate a model by overfittting:

est_m1_2 = est.ar.wge(Post_Vaccine$new_deaths_per_million, p = 8, type = 'burg') # It contains (1-B) as 

#search for p,q as per lower AIC score
aic5.wge(m2_dif1) #picks 5,2

#Estimation for final model:

m2_arma = est.arma.wge(m2_dif1, p = 5, q = 2)
mean(Post_Vaccine$new_deaths_per_million) #7.093083

fore_m2_short = fore.arma.wge(Post_Vaccine$new_deaths_per_million, phi = m2_arma$phi, theta = m2_arma$theta)
For_ase_m2_short = mean((fore_m2_short$f - Post_Vaccine$new_deaths_per_million[(95-10+1):95])^2)
For_ase_m2_short #1.77

## Colored Plot for short term
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,96))
lines(seq(87,96,1),m4_forcast_short$f  , col = "red")



```

#### Multivariate  (No Trend/lag) ####

```{r}
#Multivariate - Model 1 - No trend and no lags
PVsmall = Post_Vaccine[1:80,]
mv_fit1 <- lm( new_deaths_per_million~ new_cases_per_million+ icu_patients_per_million+hosp_patients_per_million+new_vaccinations_smoothed_per_million  ,data = PVsmall)
aic.wge(mv_fit1$residuals, p=0:8,q=0) #AIC picks 7,0 ; aic =0.8019881
fit1 = arima(PVsmall$new_deaths_per_million, order=c(7,0,0), xreg = PVsmall[,c(3,5,6,7)] )
fit1 #AIC 281.45; Only new_cases_per_million looks significant
acf(fit1$residuals) #appear to be white noise
#ljung test for white noise of residuals
ltest = ljung.wge(fit1$residuals) #null hypothesis = white noise, alternate- not white noise. pval = 0.975. Here we FTR null hypothesis, so this is white noise
ltest
#Forecast model 1
preds_mv1 = predict(fit1, newxreg = cbind(Post_Vaccine$new_cases_per_million[81:96], Post_Vaccine$icu_patients_per_million[81:96],Post_Vaccine$hosp_patients_per_million[81:96],Post_Vaccine$new_vaccinations_smoothed_per_million[81:96]))
ASE_mv1 = mean((Post_Vaccine$new_deaths_per_million[81:96] - preds_mv1$pred)^2)
ASE_mv1 #2.59
#Multivariate - No trend and no lags with only new_cases_per_million
mv_fit1_2 <- lm( new_deaths_per_million~ new_cases_per_million  ,data = PVsmall)
aic.wge(mv_fit1_2$residuals, p=0:8,q=0) #AIC picks 7,0 ; aic =0.471746
fit1_2 = arima(PVsmall$new_deaths_per_million, order=c(7,0,0), xreg = PVsmall[,c(3)] )
fit1_2 #AIC 281.45; Only new_cases_per_million looks significant
acf(fit1_2$residuals) #appear to be white noise
#ljung test for white noise of residuals
ltest = ljung.wge(fit1_2$residuals) #null hypothesis = white noise, alternate- not white noise. pval = 0.975. Here we FTR null hypothesis, so this is white noise
ltest
#Forecast model 1_2
preds_mv1_2 = predict(fit1_2, newxreg = cbind(Post_Vaccine$new_cases_per_million[81:96]  ))
ASE_mv1_2 = mean((Post_Vaccine$new_deaths_per_million[81:96] - preds_mv1_2$pred)^2)
ASE_mv1_2 #3.736719
#Model 1 - No trend and no lags has the best ASE so far.
#Multivariate - Model 2 - Trend but  no lags
t = seq(1:96)
mv_fit2 <- lm( new_deaths_per_million~ t[1:80]+new_cases_per_million+ icu_patients_per_million+hosp_patients_per_million+new_vaccinations_smoothed_per_million  ,data = PVsmall)
aic.wge(mv_fit2$residuals, p=0:8,q=0) #AIC picks 7,0, aic = 0.6252096
fit2 = arima(PVsmall$new_deaths_per_million, order=c(7,0,0), xreg = cbind(t[1:80],PVsmall[,c(3,5,6,7)]) )
fit2 #AIC aic = 274.31; time, hosp_patients_per_million looks insignificant,
acf(fit2$residuals) #appear to be white noise
#ljung test for white noise of residuals
ltest2 = ljung.wge(fit2$residuals) #null hypothesis = white noise, alternate- not white noise. pval = 0.975. Here we FTR null hypothesis, so this is white noise
ltest2
#Forecast model 2
preds_mv2 = predict(fit2, newxreg = cbind(t[81:96], Post_Vaccine$new_cases_per_million[81:96], Post_Vaccine$icu_patients_per_million[81:96],Post_Vaccine$hosp_patients_per_million[81:96],Post_Vaccine$new_vaccinations_smoothed_per_million[81:96]))
ASE_mv2 = mean((Post_Vaccine$new_deaths_per_million[81:96] - preds_mv2$pred)^2)
ASE_mv2 #5.407704
#Take hosp_patients_per_million out
mv_fit2_1 <- lm( new_deaths_per_million~ t[1:80]+new_cases_per_million+ icu_patients_per_million +new_vaccinations_smoothed_per_million  ,data = PVsmall)
aic.wge(mv_fit2_1$residuals, p=0:8,q=0) #AIC picks 7,0, aic = 0.6189045
fit2_1 = arima(PVsmall$new_deaths_per_million, order=c(7,0,0), xreg = cbind(t[1:80],PVsmall[,c(3,5,7)]) )
fit2_1 #AIC aic = 274.31; time, new_vaccinations_smoothed_per_million looks insignificant
#Forecast model 2_1
preds_mv2_1 = predict(fit2_1, newxreg = cbind(t[81:96], Post_Vaccine$new_cases_per_million[81:96], Post_Vaccine$icu_patients_per_million[81:96],Post_Vaccine$new_vaccinations_smoothed_per_million[81:96]  ))
ASE_mv2_1 = mean((Post_Vaccine$new_deaths_per_million[81:96] - preds_mv2_1$pred)^2)
ASE_mv2_1  #6.364181
#Take new_vaccinations_smoothed_per_million out
mv_fit2_2 <- lm( new_deaths_per_million~ t[1:80]+new_cases_per_million+ icu_patients_per_million   ,data = PVsmall)
aic.wge(mv_fit2_2$residuals, p=0:8,q=0) #AIC picks 7,0, aic = 0.5544063
fit2_2 = arima(PVsmall$new_deaths_per_million, order=c(7,0,0), xreg = cbind(t[1:80],PVsmall[,c(3,5)]))
fit2_2 #AIC aic = 275.97; time, AIC increased a little bit
acf(fit2_2$residuals) #appear to be white noise
#ljung test for white noise of residuals
ltest2_2 = ljung.wge(fit2_2$residuals) #null hypothesis = white noise, alternate- not white noise. pval = 0.975. Here we FTR null hypothesis, so this is white noise
ltest2_2
#Forecast model 2_1
preds_mv2_2 = predict(fit2_2, newxreg = cbind(t[81:96], Post_Vaccine$new_cases_per_million[81:96], Post_Vaccine$icu_patients_per_million[81:96]))
ASE_mv2_2 = mean((Post_Vaccine$new_deaths_per_million[81:96] - preds_mv2_2$pred)^2)
ASE_mv2_2  #6.53061 No improvememnt
#Model 1 - No trend and no lags has the best ASE so far.
#Multivariate - Model 2 - Trend and lags
#Lagged variables - all
ccf(Post_Vaccine$new_cases_per_million,Post_Vaccine$new_deaths_per_million) #7
ccf(Post_Vaccine$icu_patients_per_million,Post_Vaccine$new_deaths_per_million) #1
ccf(Post_Vaccine$hosp_patients_per_million,Post_Vaccine$new_deaths_per_million) #1
ccf(Post_Vaccine$new_vaccinations_smoothed_per_million,Post_Vaccine$new_deaths_per_million) #8
Post_Vaccine$new_cases_per_million_7 <- dplyr::lag(Post_Vaccine$new_cases_per_million,7)
Post_Vaccine$icu_patients_per_million_1 <- dplyr::lag(Post_Vaccine$icu_patients_per_million,1)
Post_Vaccine$hosp_patients_per_million_1 <- dplyr::lag(Post_Vaccine$hosp_patients_per_million,1)
Post_Vaccine$new_vaccinations_smoothed_per_million_8 <- dplyr::lag(Post_Vaccine$new_vaccinations_smoothed_per_million,8)
PVsmall = Post_Vaccine[1:80,]
mv_fit3 <- lm( new_deaths_per_million~ t[1:80]+new_cases_per_million_7+ icu_patients_per_million_1+hosp_patients_per_million_1+new_vaccinations_smoothed_per_million_8  ,data = PVsmall)
aic.wge(mv_fit3$residuals, p=0:8,q=0) #AIC picks 8,0, aic = 0.8735
fit3 = arima(PVsmall$new_deaths_per_million, order=c(8,0,0), xreg = cbind(PVsmall[,c(8,9,10,11)]) )
fit3 #AIC aic = 263.57; time, icu_patients_per_million_1 and hosp_patients_per_million_1 looks sig,
acf(fit3$residuals[9:80]) # does not appear to be white noise
ltest3 = ljung.wge(fit3$residuals)
ltest3 #FTR.There is not enough evidence to suggest that the residuals are serailly correlated. null hypothesis = white noise, alternate- not white noise. pval = 0.975. Here we FTR null hypothesis, so this is white noise
#Lagged variables - icu_patients_per_million_1 and hosp_patients_per_million_1 - Best aic so far with white noise residuals.
mv_fit3_1 <- lm( new_deaths_per_million~ t[1:80]+new_cases_per_million+ icu_patients_per_million_1+hosp_patients_per_million_1+new_vaccinations_smoothed_per_million  ,data = PVsmall)
aic.wge(mv_fit3_1$residuals, p=0:8,q=0) #AIC picks 7,0, aic = 0.5299
fit3_1 = arima(PVsmall$new_deaths_per_million, order=c(7,0,0), xreg = cbind(t[1:80],PVsmall[,c(3,9,10,7)]) )
fit3_1 #AIC= time, icu_patients_per_million_1 and hosp_patients_per_million_1 looks sig,
acf(fit3_1$residuals[8:80]) # appears to be white noise
ltest3_1 = ljung.wge(fit3_1$residuals) #FTR. There is not enough evidence to suggest that the residuals are serailly correlated. null hypothesis = white noise, alternate- not white noise. pval = 0.5670672 Here we FTR null hypothesis, so this is white noise
#Forecast model 2_1
preds_mv3_1 = predict(fit3_1, newxreg = cbind(t[81:96], Post_Vaccine$new_cases_per_million[81:96], Post_Vaccine$icu_patients_per_million_1[81:96],  Post_Vaccine$hosp_patients_per_million_1[81:96] , Post_Vaccine$new_vaccinations_smoothed_per_million[81:96]))
ASE_mv3_1 = mean((Post_Vaccine$new_deaths_per_million[81:96] - preds_mv3_1$pred)^2)
ASE_mv3_1  #4.948167
#As Model 1 (no trend, no lag) has the best ASE. We will forecast future values using this model.
m1_fit = lm(new_deaths_per_million~new_cases_per_million+new_vaccinations_smoothed_per_million+hosp_patients_per_million+icu_patients_per_million, data = Post_Vaccine)
phi = aic.wge(m1_fit$residuals)
m1_resids_14 = fore.arma.wge(m1_fit$residuals, phi = phi$phi, n.ahead = 14)
#Predicting future forecasts - 14
Pred_nc_10_m1 = fore.aruma.wge(Post_Vaccine$new_cases_per_million, n.ahead = 14)
Pred_nv_10_m1 = fore.aruma.wge(Post_Vaccine$new_vaccinations_smoothed_per_million, n.ahead = 14)
Pred_hs_10_m1 = fore.aruma.wge(Post_Vaccine$hosp_patients_per_million, n.ahead = 14)
Pred_ic_10_m1 = fore.aruma.wge(Post_Vaccine$icu_patients_per_million, n.ahead = 14)
next10_m1 = data.frame(new_cases_per_million=Pred_nc_10_m1$f, new_vaccinations_smoothed_per_million=Pred_nv_10_m1$f,hosp_patients_per_million=Pred_hs_10_m1$f,icu_patients_per_million=Pred_ic_10_m1$f)
#get predictions
preds_m1_10 = predict(m1_fit, newdata = next10_m1)
Preds_m1_10_final = preds_m1_10 + m1_resids_14$f
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,110), ylab = "new_deaths_per_million", main = "Next 10 day new_deaths_per_million Forecast")
lines(seq(97,110,1),Preds_m1_10_final, col = "red")
#Predicting future forecasts - 40
m1_resids_40 = fore.arma.wge(m1_fit$residuals, phi = phi$phi, n.ahead = 40)
Pred_nc_40_m1 = fore.aruma.wge(Post_Vaccine$new_cases_per_million, n.ahead = 40)
Pred_nv_40_m1 = fore.aruma.wge(Post_Vaccine$new_vaccinations_smoothed_per_million, n.ahead = 40)
Pred_hs_40_m1 = fore.aruma.wge(Post_Vaccine$hosp_patients_per_million, n.ahead = 40)
Pred_ic_40_m1 = fore.aruma.wge(Post_Vaccine$icu_patients_per_million, n.ahead = 40)
next40_m1 = data.frame(new_cases_per_million=Pred_nc_40_m1$f, new_vaccinations_smoothed_per_million=Pred_nv_40_m1$f,hosp_patients_per_million=Pred_hs_40_m1$f,icu_patients_per_million=Pred_ic_40_m1$f)
#get predictions
preds_m1_40 = predict(m1_fit, newdata = next40_m1)
Preds_m1_40_final = preds_m1_40 + preds_m1_40
#get predictions
preds_m1_40 = predict(m1_fit, newdata = next40_m1)
Preds_m1_40_final = preds_m1_40 + m1_resids_40$f
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,136), ylab = "new_deaths_per_million", main = "Next 40 day new_deaths_per_million Forecast")
lines(seq(97,136,1),Preds_m1_40_final, col = "red")
```

#### Multivariate  ( Trend added, no lag ) ####



```{r pressure, echo=FALSE}
#with trend

# ASE for model with no lag and trend (last 5)
t=1:96
Post_Vaccine$t = t
Post_Vaccine2 = Post_Vaccine[1:91,]
covidfit2_m2=lm(new_deaths_per_million~ t+ new_cases_per_million+icu_patients_per_million+hosp_patients_per_million
          +new_vaccinations_smoothed_per_million, data = Post_Vaccine2)
AIC(covidfit2_m2) #401.0608

M2_final_res=aic.wge(covidfit2_m2$residuals,p=0:10, q=0)  # AIC picks p=9
fit2_m2=arima(Post_Vaccine2$new_deaths_per_million,order=c(9,0,0),xreg=cbind(Post_Vaccine2$new_cases_per_million, Post_Vaccine2$icu_patients_per_million,Post_Vaccine2$hosp_patients_per_million, Post_Vaccine2$new_vaccinations_smoothed_per_million))
fit2_m2
AIC(fit2_m2) #312.5972

#Rolling Window 
Rolling_Window_ASE(Post_Vaccine$new_deaths_per_million, trainingSize = 70, horizon = 6, d = 0, phi = fit2_m2$phi, theta = 0,s= 0) #18.18726

# Predictions with trend
preds2 = predict(fit2_m2, newxreg = cbind(Post_Vaccine$new_cases_per_million[91:96], Post_Vaccine$icu_patients_per_million[91:96],Post_Vaccine$hosp_patients_per_million[91:96], Post_Vaccine$new_vaccinations_smoothed_per_million[91:96]))
ASE2 = mean((Post_Vaccine$new_deaths_per_million[91:96] - preds2$pred)^2)
ASE2 #2.491884

# Predictions with trend - long term
preds_2 = predict(fit2_m2, newxreg = cbind(Post_Vaccine$new_cases_per_million[57:96], Post_Vaccine$icu_patients_per_million[57:96],Post_Vaccine$hosp_patients_per_million[57:96], Post_Vaccine$new_vaccinations_smoothed_per_million[57:96]))
preds1$pred
ASE_2 = mean((Post_Vaccine$new_deaths_per_million[57:96] - preds_2$pred)^2)
ASE_2 #7.317226

#Pred for next 6 days

m2_fit = lm(new_deaths_per_million~t+new_cases_per_million+new_vaccinations_smoothed_per_million+hosp_patients_per_million+icu_patients_per_million, data = Post_Vaccine)

phi2 = aic.wge(m2_fit$residuals)
m2_resids = fore.arma.wge(m1_fit$residuals, phi = phi2$phi, n.ahead = 6)
Pred_nc_6_m2 = fore.aruma.wge(Post_Vaccine$new_cases_per_million, n.ahead = 6)
Pred_nv_6_m2 = fore.aruma.wge(Post_Vaccine$new_vaccinations_smoothed_per_million, n.ahead = 6)
Pred_hs_6_m2 = fore.aruma.wge(Post_Vaccine$hosp_patients_per_million, n.ahead = 6)
Pred_ic_6_m2 = fore.aruma.wge(Post_Vaccine$icu_patients_per_million, n.ahead = 6)
next6_m2 = data.frame(t = seq(97,102,1),new_cases_per_million=Pred_nc_6_m2$f, new_vaccinations_smoothed_per_million=Pred_nv_6_m2$f,hosp_patients_per_million=Pred_hs_6_m2$f,icu_patients_per_million=Pred_ic_6_m2$f)
#get predictions
preds_m2_6 = predict(m2_fit, newdata = next6_m2) 
Preds_m2_6_final = preds_m2_6 + m2_resids$f


#Pred for next 40 days

m2_fit2 = lm(new_deaths_per_million~t+new_cases_per_million+new_vaccinations_smoothed_per_million+hosp_patients_per_million+icu_patients_per_million, data = Post_Vaccine)

phi = aic.wge(m2_fit2$residuals)
m2_resids2 = fore.arma.wge(m2_fit2$residuals, phi = phi$phi, n.ahead = 40)
Pred_nc_40_m2 = fore.aruma.wge(Post_Vaccine$new_cases_per_million, n.ahead = 40)
Pred_nv_40_m2 = fore.aruma.wge(Post_Vaccine$new_vaccinations_smoothed_per_million, n.ahead = 40)
Pred_hs_40_m2 = fore.aruma.wge(Post_Vaccine$hosp_patients_per_million, n.ahead = 40)
Pred_ic_40_m2 = fore.aruma.wge(Post_Vaccine$icu_patients_per_million, n.ahead = 40)
next40_m2 = data.frame(t = seq(97,136,1),new_cases_per_million=Pred_nc_40_m2$f, new_vaccinations_smoothed_per_million=Pred_nv_40_m2$f,hosp_patients_per_million=Pred_hs_40_m2$f,icu_patients_per_million=Pred_ic_40_m2$f)
#get predictions
preds_m2_40 = predict(m2_fit2, newdata = next40_m2) 
Preds_m2_40_final = preds_m2_40 + m2_resids2$f


## Colored forecast plot for last 6 days
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,96))
lines(seq(91,96,1),preds2$pred, col = "red")

## Colored forecast plot for last 40 days 
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,97))
lines(seq(57,96,1),preds_2$pred, col = "red")

## Forecast plot for next 6 days
plot(seq(1,96,1), Post_Vaccine$new_deaths_per_million, type = "l",xlim = c(0,102), ylab = "New Death Rate Per Million", main = "New Death Per Million forecast for next 6 days")
lines(seq(97,102,1), Preds_m2_6_final, type = "l", col = "red")

## Forecast plot for next 40 days
plot(seq(1,96,1), Post_Vaccine$new_deaths_per_million, type = "l",xlim = c(0,136), ylim= c(1,17),ylab = "New Death Rate Per Million", main = "New Death Per Million forecast for next 6 days")
lines(seq(97,136,1), Preds_m2_40_final, type = "l", col = "red")


```


#### Multivariate  ( Adding Lags ) ####



```{r pressure, echo=FALSE}

#Lagging Post Vaccine variables
ccf(Post_Vaccine$new_deaths_per_million,Post_Vaccine$new_cases_per_million) #7 for lag
ccf(Post_Vaccine$new_deaths_per_million,Post_Vaccine$icu_patients_per_million) #1 for lag
ccf(Post_Vaccine$new_deaths_per_million,Post_Vaccine$hosp_patients_per_million) #8 for lag
ccf(Post_Vaccine$new_deaths_per_million,Post_Vaccine$new_vaccinations_smoothed_per_million) #1 for lag

new_cases_per_million1 = dplyr::lag(Post_Vaccine$new_cases_per_million,7)
icu_patients_per_million1 = dplyr::lag(Post_Vaccine$icu_patients_per_million,1)
hosp_patients_per_million1 = dplyr::lag(Post_Vaccine$hosp_patients_per_million,8)
new_vaccinations_smoothed_per_million1 = dplyr::lag(Post_Vaccine$new_vaccinations_smoothed_per_million,1)

Post_Vaccine$new_cases_per_million1 = new_cases_per_million1
Post_Vaccine$icu_patients_per_million1 = icu_patients_per_million1
Post_Vaccine$hosp_patients_per_million1 = hosp_patients_per_million1
Post_Vaccine$new_vaccinations_smoothed_per_million1 = new_vaccinations_smoothed_per_million1

# ASE for model3
t=1:96
Post_Vaccine$t = t
Post_Vaccine2 = Post_Vaccine[1:91,]
covidfit3_m3=lm(new_deaths_per_million~ t+ new_cases_per_million1+icu_patients_per_million1+hosp_patients_per_million1
          +new_vaccinations_smoothed_per_million1, data = Post_Vaccine2)
AIC(covidfit3_m3) #422.3541

M3_final_res=aic.wge(covidfit3_m3$residuals,p=0:10, q=0)  # AIC picks p=9
fit3_m3=arima(Post_Vaccine2$new_deaths_per_million,order=c(7,0,0),xreg=cbind(Post_Vaccine2$new_cases_per_million1, Post_Vaccine2$icu_patients_per_million1,Post_Vaccine2$hosp_patients_per_million1, Post_Vaccine2$new_vaccinations_smoothed_per_million1))
fit3_m3
AIC(fit3_m3) #287.1434

#Rolling Window 
Rolling_Window_ASE(Post_Vaccine$new_deaths_per_million, trainingSize = 70, horizon = 6, d = 0, phi = fit3_m3$phi, theta = 0,s= 0) #18.18726

# Predictions with trend for last 6 days
preds3 = predict(fit3_m3, newxreg = cbind(Post_Vaccine$new_cases_per_million[91:96], Post_Vaccine$icu_patients_per_million[91:96],Post_Vaccine$hosp_patients_per_million[91:96], Post_Vaccine$new_vaccinations_smoothed_per_million[91:96]))
ASE3 = mean((Post_Vaccine$new_deaths_per_million[91:96] - preds2$pred)^2)
ASE3 #3.045036

# Predictions with trend  for last 40 days
preds_3 = predict(fit3_m3, newxreg = cbind(Post_Vaccine$new_cases_per_million[57:96], Post_Vaccine$icu_patients_per_million[57:96],Post_Vaccine$hosp_patients_per_million[57:96], Post_Vaccine$new_vaccinations_smoothed_per_million[57:96]))
preds1$pred
ASE_3 = mean((Post_Vaccine$new_deaths_per_million[57:96] - preds_2$pred)^2)
ASE_3 #6.512361

#Pred for next 6 days

m3_fit = lm(new_deaths_per_million~new_cases_per_million1+icu_patients_per_million1+hosp_patients_per_million1
+new_vaccinations_smoothed_per_million1, data = Post_Vaccine)

phi3 = aic.wge(m3_fit$residuals)
m3_resids = fore.arma.wge(m3_fit$residuals, phi = phi2$phi, n.ahead = 6)
Pred_nc_6_m3 = fore.aruma.wge(Post_Vaccine$new_cases_per_million, n.ahead = 6)
Pred_nv_6_m3 = fore.aruma.wge(Post_Vaccine$new_vaccinations_smoothed_per_million, n.ahead = 6)
Pred_hs_6_m3 = fore.aruma.wge(Post_Vaccine$hosp_patients_per_million, n.ahead = 6)
Pred_ic_6_m3 = fore.aruma.wge(Post_Vaccine$icu_patients_per_million, n.ahead = 6)
next6_m3 = data.frame(new_cases_per_million1=Pred_nc_6_m3$f, new_vaccinations_smoothed_per_million1=Pred_nv_6_m3$f,hosp_patients_per_million1=Pred_hs_6_m3$f,icu_patients_per_million1=Pred_ic_6_m3$f)
#get predictions
preds_m3_6 = predict(m3_fit, newdata = next6_m3) 
Preds_m3_6_final = preds_m3_6 + m2_resids$f


#Pred for next 40 days

m3_fit2 = lm(new_deaths_per_million~new_cases_per_million1+icu_patients_per_million1+hosp_patients_per_million1
+new_vaccinations_smoothed_per_million1, data = Post_Vaccine)

phi3 = aic.wge(m3_fit2$residuals)
m3_resids2 = fore.arma.wge(m3_fit2$residuals, phi = phi3$phi, n.ahead = 40)
Pred_nc_40_m3 = fore.aruma.wge(Post_Vaccine$new_cases_per_million, n.ahead = 40)
Pred_nv_40_m3 = fore.aruma.wge(Post_Vaccine$new_vaccinations_smoothed_per_million, n.ahead = 40)
Pred_hs_40_m3 = fore.aruma.wge(Post_Vaccine$hosp_patients_per_million, n.ahead = 40)
Pred_ic_40_m3 = fore.aruma.wge(Post_Vaccine$icu_patients_per_million, n.ahead = 40)
next40_m3 = data.frame(new_cases_per_million1=Pred_nc_40_m3$f, new_vaccinations_smoothed_per_million1=Pred_nv_40_m3$f,hosp_patients_per_million1=Pred_hs_40_m3$f,icu_patients_per_million1=Pred_ic_40_m3$f)
#get predictions
preds_m3_40 = predict(m3_fit2, newdata = next40_m3) 
Preds_m3_40_final = preds_m3_40 + m3_resids2$f

## Forecast plot for last 6 days
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,96))
lines(seq(91,96,1),preds3$pred, col = "red")

## Forecast plot for last 40 days
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,96))
lines(seq(57,96,1),preds_3$pred, col = "red")

## Forecast plot for next 6 days
plot(seq(1,96,1), Post_Vaccine$new_deaths_per_million, type = "l",xlim = c(0,102), ylab = "New Death Rate Per Million", main = "New Death Per Million forecast for next 6 days")
lines(seq(97,102,1), Preds_m3_6_final, type = "l", col = "red")

## Forecast plot for next 40 days
plot(seq(1,96,1), Post_Vaccine$new_deaths_per_million, type = "l",xlim = c(0,136), ylim= c(1,17),ylab = "New Death Rate Per Million", main = "New Death Per Million forecast for next 6 days")
lines(seq(97,136,1), Preds_m3_40_final, type = "l", col = "red")



```



#### Forecast Features ####



```{r pressure, echo=FALSE}


ests_newc = aic.wge(Post_Vaccine$new_cases_per_million)
est_new_case = est.arma.wge(Post_Vaccine$new_cases_per_million,p = 5, q = 1)
Fore_newcase = fore.arma.wge(Post_Vaccine$new_cases_per_million,phi = est_new_case$phi, theta = est_new_case$theta, n.ahead = 5)


ests_icu = aic.wge(Post_Vaccine$icu_patients_per_million) #picks 2,1
est_icu = est.arma.wge(Post_Vaccine$icu_patients_per_million,p = 2, q = 1)
Fore_icu = fore.arma.wge(Post_Vaccine$icu_patients_per_million,phi = est_icu$phi, theta = est_icu$theta, n.ahead = 5)

ests_hosp = aic.wge(Post_Vaccine$hosp_patients_per_million) #picks 4,1
est_hosp = est.arma.wge(Post_Vaccine$hosp_patients_per_million,p = 4, q = 1)
Fore_hos = fore.arma.wge(Post_Vaccine$hosp_patients_per_million,phi = est_hosp$phi, theta = est_hosp$theta, n.ahead = 5)

ests_vaccine = aic.wge(Post_Vaccine$new_vaccinations_smoothed_per_million) #picks 3,1
est_vaccine = est.arma.wge(Post_Vaccine$new_vaccinations_smoothed_per_million,p = 3, q = 1)
Fore_vaccine = fore.arma.wge(Post_Vaccine$new_vaccinations_smoothed_per_million,phi = est_vaccine$phi, theta = est_vaccine$theta, n.ahead = 5)





```

#### with trend and lagging ####



```{r pressure, echo=FALSE}

Fore_newcase1 = lag(Fore_newcase,1)
Fore_icu1 = lag(Fore_icu,1)
Fore_hos1 = lag(Fore_hos,1)
Fore_vaccine1 = lag(Fore_vaccine,1)

t=1:96
Post_Vaccine$t = t
Post_Vaccine2 = Post_Vaccine[1:91,]
covidfit4_m4=lm(new_deaths_per_million~ t+ new_cases_per_million1+icu_patients_per_million1+hosp_patients_per_million1
          +new_vaccinations_smoothed_per_million1, data = Post_Vaccine2)
AIC(covidfit4_m4) #422.4621

M4_final_res=aic.wge(covidfit4_m4$residuals,p=0:10, q=0)  # AIC picks p=8
fit4_m4=arima(Post_Vaccine2$new_deaths_per_million,order=c(8,0,0),xreg=cbind(Post_Vaccine2$new_cases_per_million1, Post_Vaccine2$icu_patients_per_million1,Post_Vaccine2$hosp_patients_per_million1, Post_Vaccine2$new_vaccinations_smoothed_per_million1))
fit4_m4
AIC(fit4_m4)

# Predictions with trend
preds4 = predict(fit4_m4, newxreg = cbind(Post_Vaccine$new_cases_per_million[91:96], Post_Vaccine$icu_patients_per_million[91:96],Post_Vaccine$hosp_patients_per_million[91:96], Post_Vaccine$new_vaccinations_smoothed_per_million[91:96]))
ASE4 = mean((Post_Vaccine$new_deaths_per_million[91:96] - preds4$pred )^2)
ASE4 #2.528183

# Predictions with trend - long term
preds_4 = predict(fit4_m4, newxreg = cbind(Post_Vaccine$new_cases_per_million[57:96], Post_Vaccine$icu_patients_per_million[57:96],Post_Vaccine$hosp_patients_per_million[57:96], Post_Vaccine$new_vaccinations_smoothed_per_million[57:96]))

ASE_4 = mean((Post_Vaccine$new_deaths_per_million[57:96] - preds_4$pred)^2)
ASE_4 #6.11206

#Pred for next 6 days

m3_fit = lm(new_deaths_per_million~t+ new_cases_per_million1+icu_patients_per_million1+hosp_patients_per_million1
+new_vaccinations_smoothed_per_million1, data = Post_Vaccine)

phi3 = aic.wge(m3_fit$residuals)
m3_resids = fore.arma.wge(m3_fit$residuals, phi = phi2$phi, n.ahead = 6)
Pred_nc_6_m3 = fore.aruma.wge(Post_Vaccine$new_cases_per_million, n.ahead = 6)
Pred_nv_6_m3 = fore.aruma.wge(Post_Vaccine$new_vaccinations_smoothed_per_million, n.ahead = 6)
Pred_hs_6_m3 = fore.aruma.wge(Post_Vaccine$hosp_patients_per_million, n.ahead = 6)
Pred_ic_6_m3 = fore.aruma.wge(Post_Vaccine$icu_patients_per_million, n.ahead = 6)
next6_m3 = data.frame(t = seq(97,102,1),new_cases_per_million1=Pred_nc_6_m3$f, new_vaccinations_smoothed_per_million1=Pred_nv_6_m3$f,hosp_patients_per_million1=Pred_hs_6_m3$f,icu_patients_per_million1=Pred_ic_6_m3$f)
#get predictions
preds_m3_6 = predict(m3_fit, newdata = next6_m3) 
Preds_m3_6_final = preds_m3_6 + m2_resids$f


#Pred for next 40 days

m3_fit2 = lm(new_deaths_per_million~t+ new_cases_per_million1+icu_patients_per_million1+hosp_patients_per_million1
+new_vaccinations_smoothed_per_million1, data = Post_Vaccine)

phi3 = aic.wge(m3_fit2$residuals)
m3_resids2 = fore.arma.wge(m3_fit2$residuals, phi = phi3$phi, n.ahead = 40)
Pred_nc_40_m3 = fore.aruma.wge(Post_Vaccine$new_cases_per_million, n.ahead = 40)
Pred_nv_40_m3 = fore.aruma.wge(Post_Vaccine$new_vaccinations_smoothed_per_million, n.ahead = 40)
Pred_hs_40_m3 = fore.aruma.wge(Post_Vaccine$hosp_patients_per_million, n.ahead = 40)
Pred_ic_40_m3 = fore.aruma.wge(Post_Vaccine$icu_patients_per_million, n.ahead = 40)
next40_m3 = data.frame(t = seq(97,136,1),new_cases_per_million1=Pred_nc_40_m3$f, new_vaccinations_smoothed_per_million1=Pred_nv_40_m3$f,hosp_patients_per_million1=Pred_hs_40_m3$f,icu_patients_per_million1=Pred_ic_40_m3$f)
#get predictions
preds_m3_40 = predict(m3_fit2, newdata = next40_m3) 
Preds_m3_40_final = preds_m3_40 + m3_resids2$f

## Forecast plot for last 6 days
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,96))
lines(seq(91,96,1),preds4$pred, col = "red")

## Forecast plot for last 40 days
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,96))
lines(seq(57,96,1),preds_4$pred, col = "red")

## Forecast plot for next 6 days
plot(seq(1,96,1), Post_Vaccine$new_deaths_per_million, type = "l",xlim = c(0,102), ylab = "New Death Rate Per Million", main = "New Death Per Million forecast for next 6 days")
lines(seq(97,102,1), Preds_m3_6_final, type = "l", col = "red")

## Forecast plot for next 40 days
plot(seq(1,96,1), Post_Vaccine$new_deaths_per_million, type = "l",xlim = c(0,136), ylim= c(1,17),ylab = "New Death Rate Per Million", main = "New Death Per Million forecast for next 6 days")
lines(seq(97,136,1), Preds_m3_40_final, type = "l", col = "red")



```


#### VAR MODEL 1 ####



```{r pressure, echo=FALSE}

Post_Vaccine2 = Post_Vaccine[1:91,]
Post_Vaccine2_long = Post_Vaccine[1:56,]

VaccineVar1 = VAR(cbind(Post_Vaccine2$new_cases_per_million, Post_Vaccine2$new_deaths_per_million, Post_Vaccine2$icu_patients_per_million,Post_Vaccine2$hosp_patients_per_million, Post_Vaccine2$new_vaccinations_smoothed_per_million), type = 'both', lag.max = 5)
AIC(VaccineVar1) #3084.604

VaccineVar1_long = VAR(cbind(Post_Vaccine2_long$new_cases_per_million, Post_Vaccine2_long$new_deaths_per_million, Post_Vaccine2_long$icu_patients_per_million,Post_Vaccine2_long$hosp_patients_per_million, Post_Vaccine2_long$new_vaccinations_smoothed_per_million), type = 'both', lag.max = 5)
AIC(VaccineVar1_long) #1729.743

preds6 = predict(VaccineVar1, n.ahead = 6)
preds_6 = predict(VaccineVar1_long, n.ahead = 40)
ASE5_short = mean((Post_Vaccine$new_deaths_per_million[91:96] - preds6$fcst$y2[,1])^2)
ASE5 #11.84746
ASE5_long = mean((Post_Vaccine$new_deaths_per_million[57:96] - preds_6$fcst$y2[,1])^2)
ASE5 #11.84746

## Colored forecast plot for last 6 days
plot(seq(1,96,1), Post_Vaccine$new_deaths_per_million, type = "l",xlim = c(0,96), ylab = "Death Rate Per Million", main = "forecast plot for last 6 days")
lines(seq(91,96), preds6$fcst$y2[,1], type = "l", col = "red")

## Colored forecast plot for last 40 days 
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,96),ylab = "Death Rate Per Million")
lines(seq(57,96,1),preds_6$fcst$y2[,1], col = "red")

#############################
## Simer's part: VAR Model 1
#############################

PVsmall = Post_Vaccine[1:80,]
VAR_PV = VAR(cbind(PVsmall$new_deaths_per_million,PVsmall$new_cases_per_million,PVsmall$icu_patients_per_million,PVsmall$hosp_patients_per_million,PVsmall$new_vaccinations_smoothed_per_million),lag.max = 8, type = "both")
pred = predict(VAR_PV,n.ahead = 16)
plot(Post_Vaccine$new_deaths_per_million, type = "l")
lines(seq(81,96,1),pred$fcst$y1[,1],col = "red")
ASE = mean((Post_Vaccine$new_deaths_per_million[81:96] - pred$fcst$y1[1:16])^2)
ASE #2.237209
pred = predict(VAR_PV,n.ahead = 36)
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,116))
lines(seq(97,116,1),tail(pred$fcst$y1[,1],20), col = "red")
pred = predict(VAR_PV,n.ahead = 236)
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,316))
lines(seq(97,316,1),tail(pred$fcst$y1[,1],220), col = "red")


```


#### VAR MODEL 2 - const####


```{r pressure, echo=FALSE}

VaccineVar2_short = VAR(cbind(Post_Vaccine2$new_cases_per_million, Post_Vaccine2$new_deaths_per_million, Post_Vaccine2$icu_patients_per_million,Post_Vaccine2$hosp_patients_per_million, Post_Vaccine2$new_vaccinations_smoothed_per_million), type = 'const', lag.max = 5)
AIC(VaccineVar2_short) #3104.65

VaccineVar2_long = VAR(cbind(Post_Vaccine2_long$new_cases_per_million, Post_Vaccine2_long$new_deaths_per_million, Post_Vaccine2_long$icu_patients_per_million,Post_Vaccine2_long$hosp_patients_per_million, Post_Vaccine2_long$new_vaccinations_smoothed_per_million), type = 'const', lag.max = 5)
AIC(VaccineVar2_long) #1737.859




preds7_6days = predict(VaccineVar2_short, n.ahead = 6)
preds_7_40days = predict(VaccineVar2_long, n.ahead = 40)

ASE7_short = mean((Post_Vaccine$new_deaths_per_million[91:96] - preds7_6days$fcst$y2[,1])^2)
ASE7_short #3.967338
ASE7_long = mean((Post_Vaccine$new_deaths_per_million[57:96] - preds_7_40days$fcst$y2[,1])^2)
ASE7_long #7.514837

## Colored forecast plot for last 6 days
plot(seq(1,96,1), Post_Vaccine$new_deaths_per_million, type = "l",xlim = c(0,96), ylab = "Death Rate Per Million", main = "forecast plot for last 6 days")
lines(seq(91,96), preds7$fcst$y2[,1], type = "l", col = "red")

## Colored forecast plot for last 40 days
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,96))
lines(seq(57,96,1),preds_7_40days$fcst$y2[,1], col = "red")

###############################
## Simer's part: VAR model # 2
###############################

#lagged icu_1, hosp_1
VAR_PV = VAR(cbind(PVsmall$new_deaths_per_million[2:80],PVsmall$new_cases_per_million[2:80],PVsmall$icu_patients_per_million_1[2:80],PVsmall$hosp_patients_per_million_1[2:80],PVsmall$new_vaccinations_smoothed_per_million[2:80]),lag.max = 8, type = "both")
pred = predict(VAR_PV,n.ahead = 16)
plot(Post_Vaccine$new_deaths_per_million, type = "l")
lines(seq(81,96,1),pred$fcst$y1[,1],col = "red")
ASE = mean((Post_Vaccine$new_deaths_per_million[81:96] - pred$fcst$y1[1:16])^2)
ASE #1.91
pred = predict(VAR_PV,n.ahead = 40)
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,120),ylab = "new_deaths_per_million", main = "Next 120 day new_deaths_per_million Forecast")
lines(seq(97,120,1),tail(pred$fcst$y1[,1],24), col = "red")
#Model entire data
VAR_PV = VAR(cbind(Post_Vaccine$new_deaths_per_million[2:96],Post_Vaccine$new_cases_per_million[2:96],Post_Vaccine$icu_patients_per_million_1[2:96],Post_Vaccine$hosp_patients_per_million_1[2:96],Post_Vaccine$new_vaccinations_smoothed_per_million[2:96]),lag.max = 8, type = "both", p=1)
pred = predict(VAR_PV,n.ahead = 24)
plot(Post_Vaccine$new_deaths_per_million, type = "l", xlim = c(1,125))
lines(seq(97,120,1),pred$fcst$y1[,1],col = "red")
pred = predict(VAR_PV,n.ahead = 44)
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,160),ylab = "new_deaths_per_million", main = "Next 120 day new_deaths_per_million Forecast")
lines(seq(97,140,1),pred$fcst$y1[,1], col = "red")

```


#### MLP With Vaccine Variable Only####


```{r pressure, echo=FALSE}
library(nnfor)
library(forecast)
library(vars)
library(tswge)
Vacc_Train = Post_Vaccine[1:90,]
Vacc_Test = Post_Vaccine[91:96,]
Vacc_Train2 = Post_Vaccine[1:56,]
Vacc_Test2 = Post_Vaccine[57:96,]
Vacc_xreg = data.frame(Vaccine = ts(Vacc_Train$new_vaccinations_smoothed_per_million))
set.seed(2)
Vacc_fit.mlp1 = mlp(ts(Vacc_Train$new_deaths_per_million) ,reps = 50,comb = "mean", xreg = Vacc_xreg ) 
Vacc_fit.mlp1_ = mlp(ts(Vacc_Train2$new_deaths_per_million) ,reps = 50,comb = "mean", xreg = Vacc_xreg ) #combine all 50 #combine all 50 forcast
Vacc_fit.mlp1 # 5 hnode #mse 1.11
plot(Vacc_fit.mlp1)
fore_vacc_df_exp = data.frame(Vaccine = ts(Post_Vaccine$new_vaccinations_smoothed_per_million))
Vacc_fore.mlp1 = forecast(Vacc_fit.mlp1, h = 6, xreg = fore_vacc_df) 
Vacc_fore.mlp2 = forecast(Vacc_fit.mlp1_, h = 40, xreg = fore_vacc_df) 
plot(Vacc_fore.mlp1)
MLP_ASE1_short = mean((Vacc_Test$new_deaths_per_million- Vacc_fore.mlp1$mean)^2)
MLP_ASE1_short #2.030371 
MLP_ASE1_long = mean((Vacc_Test2$new_deaths_per_million- Vacc_fore.mlp2$mean)^2)
MLP_ASE1_long #16.35241

## Colored forecast plot for last 6 days
plot(seq(1,96,1), Post_Vaccine$new_deaths_per_million, type = "l",xlim = c(0,96), ylab = "Death Rate Per Million", main = "forecast plot for last 6 days")
lines(seq(91,96), Vacc_fore.mlp1$mean, type = "l", col = "red")

## Colored forecast plot for last 40 days
plot(as.numeric(Post_Vaccine$new_deaths_per_million), type = "l", xlim = c(1,96))
lines(seq(57,96,1),Vacc_fore.mlp2$mean, col = "red")

## Forecast for next 6 days
vacc_fit.mlp1 = mlp(ts(Post_Vaccine$new_deaths_per_million),reps = 50, comb = "mean")
fore.vacc = forecast(vacc_fit.mlp1, h = 6)

vacc_fore = data.frame(Vaccine = ts(fore.vacc$mean))
vacc_fore
Vacc_xreg_all = data.frame(Vaccine_all = ts(Post_Vaccine$new_vaccinations_smoothed_per_million))
fit.mlp1 = mlp(ts(Post_Vaccine$new_deaths_per_million),reps = 50,comb = "mean",xreg = Vacc_xreg_all)
fit.mlp1
plot(fit.mlp1)
VCDF = data.frame(VC = ts(c(Vacc_xreg_all$Vaccine_all,vacc_fore$Vaccine)))
fore.mlp1 = forecast(fit.mlp1, h = 6, xreg = VCDF)
plot(fore.mlp1)

## Forecast for next 40 days
vacc_fit.mlp2 = mlp(ts(Post_Vaccine$new_deaths_per_million),reps = 50, comb = "mean")
fore.vacc2 = forecast(vacc_fit.mlp1, h = 40)

vacc_fore2 = data.frame(Vaccine2 = ts(fore.vacc2$mean))
vacc_fore2
Vacc_xreg_all = data.frame(Vaccine_all = ts(Post_Vaccine$new_vaccinations_smoothed_per_million))
fit.mlp1 = mlp(ts(Post_Vaccine$new_deaths_per_million),reps = 50,comb = "mean",xreg = Vacc_xreg_all)
fit.mlp1
plot(fit.mlp1)
VCDF2 = data.frame(VC = ts(c(Vacc_xreg_all$Vaccine_all,vacc_fore2$Vaccine2)))
fore.mlp2 = forecast(fit.mlp1, h = 40, xreg = VCDF2)
plot(fore.mlp2)


```


#### MLP With all explanatory variables####

```{r pressure, echo=FALSE}
library(nnfor)
library(forecast)
library(vars)
library(tswge)
VC_train = Post_Vaccine[1:80,]
VC_test = Post_Vaccine[81:96,]

all_exp_xreg = data.frame(Vaccine = ts(t = ts(seq(1:80)),VC_train$new_vaccinations_smoothed_per_million), NewCase = ts(VC_train$new_cases_per_million), Hosp = ts(VC_train$hosp_patients_per_million), ICU = ts(VC_train$icu_patients_per_million))
set.seed(2)
allexp_fit_mlp2 = mlp(ts(VC_train$new_deaths_per_million), reps = 50, comb = "median",  xreg = all_exp_xreg )
plot(allexp_fit_mlp2)
fore_all_exp_df = data.frame(Vaccine = ts(Post_Vaccine$new_vaccinations_smoothed_per_million), NewCase = ts(Post_Vaccine$new_cases_per_million), Hosp = ts(Post_Vaccine$hosp_patients_per_million), ICU = ts(Post_Vaccine$icu_patients_per_million))
allexp_fore.m2 = forecast(allexp_fit_mlp2, h = 16, xreg = fore_all_exp_df) 
MLP2_ASE = mean((VC_test$new_deaths_per_million- allexp_fore.m2$mean)^2)
MLP2_ASE #1.28

#Forecast - fitting on last 16 days
plot(seq(1,96,1), Post_Vaccine$new_deaths_per_million, type = "l",xlim = c(0,96), ylab = "Death Rate Per Million", main = "forecast plot for last 6 days")
lines(seq(81,96), allexp_fore.m2$mean, type = "l", col = "red")

### Forecast on future short term (14 days) and long term (40 days) ###

#New Case Forecast
fit.mlp.NC = mlp(ts(Post_Vaccine$new_cases_per_million),reps = 50,comb = "median")

fore.mlp2.14.NC = forecast(fit.mlp.NC, h = 14)
fore.mlp2.40.NC = forecast(fit.mlp.NC, h = 40)
plot(fore.mlp2.14.NC) #for short term
plot(fore.mlp2.40.NC) #for long term


#New Vacc
fit.mlp.NV = mlp(ts(Post_Vaccine$new_vaccinations_smoothed_per_million),reps = 50,comb = "median")
fore.mlp2.14.NV = forecast(fit.mlp.NV, h = 14)
fore.mlp2.40.NV = forecast(fit.mlp.NV, h = 40)
plot(fore.mlp2.14.NV) #for short term
plot(fore.mlp2.40.NV) #for long term

#New Hos
fit.mlp.HS = mlp(ts(Post_Vaccine$hosp_patients_per_million),reps = 50,comb = "median")
fore.mlp2.14.HS = forecast(fit.mlp.HS, h = 14)
fore.mlp2.40.HS = forecast(fit.mlp.HS, h = 40)
plot(fore.mlp2.14.HS) #for short term
plot(fore.mlp2.40.HS) #for long term

#New ICU
fit.mlp.IC = mlp(ts(Post_Vaccine$icu_patients_per_million),reps = 50,comb = "median")
fore.mlp2.14.IC = forecast(fit.mlp.HS, h = 14)
fore.mlp2.40.IC = forecast(fit.mlp.HS, h = 40)
plot(fore.mlp2.14.IC) #for short term
plot(fore.mlp2.40.IC) #for long term

#Forecast 14 days

PV_DF_fore1 = data.frame(t = ts(seq(1:110)),new_cases_per_million = ts(c(Post_Vaccine$new_cases_per_million,fore.mlp2.14.NC$mean)), icu_patients_per_million = ts(c(Post_Vaccine$icu_patients_per_million,fore.mlp2.14.IC$mean)),
                        hosp_patients_per_million = ts(c(Post_Vaccine$hosp_patients_per_million,fore.mlp2.14.HS$mean)), new_vaccinations_smoothed_per_million =ts(c(Post_Vaccine$new_vaccinations_smoothed_per_million,fore.mlp2.14.NV$mean)))

fit.mlp2_16 = mlp(ts(Post_Vaccine$new_deaths_per_million),reps = 50,comb = "median",xreg = PV_DF_fore1)
fore.mlp2_16 = forecast(fit.mlp2_16, h = 14, xreg = PV_DF_fore1)
plot(fore.mlp2_16)


#Forecast 40 days

PV_DF_fore = data.frame(t = ts(seq(1:136)),new_cases_per_million = ts(c(Post_Vaccine$new_cases_per_million,fore.mlp2.40.NC$mean)), icu_patients_per_million = ts(c(Post_Vaccine$icu_patients_per_million,fore.mlp2.40.IC$mean)),
                        hosp_patients_per_million = ts(c(Post_Vaccine$hosp_patients_per_million,fore.mlp2.40.HS$mean)), new_vaccinations_smoothed_per_million =ts(c(Post_Vaccine$new_vaccinations_smoothed_per_million,fore.mlp2.40.NV$mean)))

fit.mlp2_40 = mlp(ts(Post_Vaccine$new_deaths_per_million),reps = 50,comb = "median",xreg = PV_DF_fore)
fore.mlp2_40 = forecast(fit.mlp2_40, h = 40, xreg = PV_DF_fore)
plot(fore.mlp2_40)





```



#### Ensemble Model with NN (all variables) Model and VAR 2####

```{r pressure, echo=FALSE}

ensemble  = (preds6$fcst$y2[,1] + allexp_fore.m2p1$mean)/2

#Plot
plot(seq(1,96,1), Post_Vaccine$new_deaths_per_million, type = "l",xlim = c(0,96), ylab = "Death Rate Per Million", main = "Ensemble Model with NN (All Var) vs VAR 2 model")
lines(seq(91,96,1), ensemble, type = "l", col = "green")

ASE_en = mean((Post_Vaccine$new_deaths_per_million[91:96] - ensemble)^2)
ASE_en #5.659218


```































